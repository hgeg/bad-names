name: Build and Release

on:
  push:
    paths:
      - 'package.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Check and Setup Haskell Stack
      run: |
        if ! command -v stack &> /dev/null; then
          curl -sSL https://get.haskellstack.org/ | sh
        fi

    - name: Extract Version Info
      run: |
        APP_VERSION=$(grep "^version:" package.yaml | awk '{print $2}')
        GHC_VERSION=$(grep "^resolver:" stack.yaml | awk -F'/' '{print $3}')
        STACK_VERSION=$(stack --version | head -n 1 | awk '{print $2}')
        echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
        echo "GHC_VERSION=$GHC_VERSION" >> $GITHUB_ENV
        echo "STACK_VERSION=$STACK_VERSION" >> $GITHUB_ENV

    - name: Build Project
      run: |
        stack setup
        stack build --system-ghc

    - name: Generate Executable
      run: |
        stack install

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: v${{ env.APP_VERSION }}
        release_name: Release v${{ env.APP_VERSION }}

    - name: Upload Executable to Release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ~/.local/bin/your_executable_name
        asset_name: your_executable_name
        asset_content_type: application/octet-stream
